<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>TorBox Usenet/Torrent Search</title>
<style>
  body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 1rem; background: #f7f9fc; color: #222; }
  input, button { font-size: 1rem; padding: 0.5rem; margin: 0.25rem 0; }
  input { width: 100%; box-sizing: border-box; }
  table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
  th, td { padding: 0.5rem; border-bottom: 1px solid #ccc; text-align: left; }
  button { cursor: pointer; background: #007aff; color: white; border: none; border-radius: 4px; }
  button:disabled { background: #aaa; cursor: default; }
  #status { margin-top: 1rem; font-style: italic; }
  #apiKeySection { margin-bottom: 1rem; }
</style>
</head>
<body>

<h2>TorBox Usenet/Torrent Search</h2>

<div id="apiKeySection">
  <label for="apiKey">TorBox API Key:</label>
  <input type="password" id="apiKey" placeholder="Paste your API key here" />
  <button id="saveKeyBtn">Save API Key</button>
</div>

<button id="changeKeyBtn" style="display:none; margin-bottom: 1rem;">Change API Key</button>

<label for="searchQuery">Search Query:</label>
<input type="text" id="searchQuery" placeholder="e.g. Inception 1080p" />

<button id="searchBtn">Search</button>

<div id="status"></div>

<table id="resultsTable" style="display:none;">
  <thead>
    <tr>
      <th>Title</th>
      <th>Size</th>
      <th>Type</th>
      <th>Action</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
  const apiBase = 'https://api.torbox.app/v1';
  const apiKeySection = document.getElementById('apiKeySection');
  const apiKeyInput = document.getElementById('apiKey');
  const saveKeyBtn = document.getElementById('saveKeyBtn');
  const changeKeyBtn = document.getElementById('changeKeyBtn');
  const searchQueryInput = document.getElementById('searchQuery');
  const searchBtn = document.getElementById('searchBtn');
  const resultsTable = document.getElementById('resultsTable');
  const resultsBody = resultsTable.querySelector('tbody');
  const statusDiv = document.getElementById('status');

  function hideApiKeyInput() {
    apiKeySection.style.display = 'none';
    changeKeyBtn.style.display = 'inline-block';
  }

  function showApiKeyInput() {
    apiKeySection.style.display = 'block';
    changeKeyBtn.style.display = 'none';
    resultsTable.style.display = 'none';
    resultsBody.innerHTML = '';
    statusDiv.textContent = '';
  }

  // Load saved API key on startup
  const savedKey = localStorage.getItem('torboxApiKey');
  if(savedKey) {
    apiKeyInput.value = savedKey;
    hideApiKeyInput();
  }

  saveKeyBtn.addEventListener('click', () => {
    const key = apiKeyInput.value.trim();
    if(key.length === 0) {
      alert('Please enter a valid API key.');
      return;
    }
    localStorage.setItem('torboxApiKey', key);
    hideApiKeyInput();
  });

  changeKeyBtn.addEventListener('click', () => {
    localStorage.removeItem('torboxApiKey');
    apiKeyInput.value = '';
    showApiKeyInput();
  });

  async function searchTorBox(query) {
    statusDiv.textContent = 'Searching...';
    resultsBody.innerHTML = '';
    resultsTable.style.display = 'none';

    const apiKey = localStorage.getItem('torboxApiKey');
    if(!apiKey) {
      statusDiv.textContent = 'Please enter your API key.';
      showApiKeyInput();
      return;
    }
    if(!query) {
      statusDiv.textContent = 'Please enter a search query.';
      return;
    }

    try {
      const resp = await fetch(`/search?q=`, {
        headers: { 'Authorization': `Bearer ` }
      });
      if(!resp.ok) {
  const errorText = await resp.text();
  throw new Error(`API error: ${resp.status} ${resp.statusText} - ${errorText}`);
}
      const results = await resp.json();
      if(results.length === 0) {
        statusDiv.textContent = 'No results found.';
        return;
      }

      // Show results
      results.forEach(item => {
        const tr = document.createElement('tr');

        const titleTd = document.createElement('td');
        titleTd.textContent = item.title;
        tr.appendChild(titleTd);

        const sizeTd = document.createElement('td');
        sizeTd.textContent = item.size || 'N/A';
        tr.appendChild(sizeTd);

        const typeTd = document.createElement('td');
        typeTd.textContent = item.type || 'Unknown';
        tr.appendChild(typeTd);

        const actionTd = document.createElement('td');
        const addBtn = document.createElement('button');
        addBtn.textContent = 'Add Download';
        addBtn.onclick = () => addDownload(item.link);
        actionTd.appendChild(addBtn);
        tr.appendChild(actionTd);

        resultsBody.appendChild(tr);
      });

      resultsTable.style.display = '';
      statusDiv.textContent = `Found  results.`;
    } catch (e) {
      statusDiv.textContent = 'Error: ' + e.message;
    }
  }

  async function addDownload(url) {
    const apiKey = localStorage.getItem('torboxApiKey');
    statusDiv.textContent = 'Adding download...';
    try {
      const resp = await fetch(`/download`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer `,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ url })
      });
      if(!resp.ok) {
        throw new Error(`API error:  `);
      }
      statusDiv.textContent = 'Download added successfully!';
    } catch (e) {
      statusDiv.textContent = 'Error adding download: ' + e.message;
    }
  }

  searchBtn.addEventListener('click', () => {
    const query = searchQueryInput.value.trim();
    searchTorBox(query);
  });

  // Optional: press Enter to search
  searchQueryInput.addEventListener('keydown', (e) => {
    if(e.key === 'Enter') {
      searchBtn.click();
    }
  });
</script>

</body>
</html>
